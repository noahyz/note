## Redis 主从复制

### 概念

主从复制，是指将一台Redis服务器的数据，复制到其他Redis 服务器，前者称为主节点（master/leader），后者称为从节点（slave/follower）；数据的复制是单向的，只能由主节点到从节点。Master 以写为主，Slave 以读为主。

默认情况下，每台Redis 服务器都是主节点；且一个主节点可以有多个从节点（或者没有从节点），但一个从节点只能有一个主节点。

**主从复制的作用主要包括：**

1. 数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式
2. 故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余
3. 负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis 数据时应当连接主节点，读Redis数据时应当连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis 服务器的并发量
4. 高可用（集群）基石：除了上述作用之外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis 高可用的基础

一般来说，要将Redis 运行于工程项目中，只使用一台Redis是万万不能的（宕机），原因如下：

1. 从结构上，单个Redis 服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大
2. 从容量上，单个Redis 服务器内存容量有限，就算一台Redis 服务器内存容量为 256G，也不能将所有内存用作Redis 存储内存，一般来说，**单台Redis 最大使用内存不应该超过20G**

### 环境配置

只配置从库，不用配置主库

```
127.0.0.1:6379> info replication  # 查看当前库的信息 
# Replication
role:master   # 角色 master
connected_slaves:0
master_failover_state:no-failover
master_replid:8c3bda110884e255a289720ffb126dd246ed2549
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
```

复制3个配置文件，然后修改对应的信息

1. 端口 `port 6379`
2. pid 名字  `pidfile /var/run/redis_6379.pid`
3. log 文件名字  `logfile "6379.log"`
4. dump.rdb 名字   ` dbfilename dump_79.rdb` 

### 一主二从

默认情况下，没台redis 服务器都是主节点；我们一般只需要配置从机就好

```
slaveeof 127.0.0.1 6379 # 配置主机
info replication # 查看信息
```

真是的主从配置应该在配置文件中配置，这样的话是永久的，如果使用命令就是暂时的

主机断开连接，从机依旧连接到主机的，但是没有写操作。主机如果回来了，从机依旧可以直接获取到主机写的信息

如果使用命令行来配置的主从，如果从机重启了，配置就会丢失，变成主机。

> 复制原理

Slave 启动成功连接到 Master 后会发送一个 sync 同步命令

Master 接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，master 将传送整个数据文件到Slave，并完成一次完全同步

全量复制：Slave 服务在接受到数据库文件数据之后，将其存盘并加载到内存中

增量复制：Master 继续将新的所有收集到的修改命令依次传给 Slave，完成同步。但是只要是重新连接 master，一次完全同步（全量复制）将被自动执行，我们的数据一定可以在从机中看到。

