---
title: 自建调度
---

自建调度代码浅析。项目：CDN-oc-diskpatch。地址：https://git.corp.kuaishou.com/cdn-team/traffic-director/cdn-oc-dispatch

功能：计算下发比





main 主程序来自于 `cdndispatch/oc-thirdparty.cc` 

读取 `cdn.dispatch.nodeServiceDispatcher` 的 kConf 配置，先解析成 CdnThirdpartDispatchTable 格式，然后再转换成 ThirdPartyCdnDispatchTable 格式。

```
typedef struct tailrange_type {
        uint32_t down_to;
        uint32_t up_to;
} TailRange_t;

struct CdnTailConf_t {
        uint32_t   priority;
        string     isp;
        list<string>     provincelist;
        list<string>     countrylist;
        string      city;
        list<TailRange_t> range; 
        list<string> cdn_name;
};
typedef struct CdnThirdpartDispatchTableype {
        uint64_t  timestamp;
        uint32_t  cdn_tail_base_number;  
        uint32_t  headbg_tail_base_number;  
        uint32_t  hot_tail_base_number; 
        list<CdnTailConf_t> cdn_service_conf;
        list<CdnTailConf_t> cdn_headbg_conf;
        list<CdnTailConf_t> cdn_hot_conf;
} CdnThirdpartDispatchTable;


// 各家CDN的调度配置，跟现有静态调度表类似
message CdnTailConf {
    // 采用all主要是为了兼容现有配置
    string isp = 1; // 运营商，「all」表示所有运营商
    string country = 2; // 国家，「foreign」表示国外默认，「all」表示所有国家, 见java类 com.kuaishou.ip.constant.Country
    string province = 3; // 省份，英文名字，「all」表示该国家的所有省份, 仅大陆有此字段, 见java类 com.kuaishou.ip.constant.ChinaProvince
    string city = 4; // 城市，英文名字，「all」表示该省份的所有城市

    repeated TailRange range = 5; // 左闭右闭，如果只匹配某一个尾号也需要转换为区间，例如只配置20，需要转换为：[20, 20]
    repeated string cdn_name = 6; // 自然顺序代表其优先级(出现的先后次序)，优先采用排在前面的，cdn的英文名称
}
message CdnDispatchTable {
    uint32 tail_base_number = 1;
    repeated CdnTailConf cdn_tail_conf = 2;
}
message ThirdPartyCdnDispatchTable {
    uint64 timestamp = 1; // 毫秒，可以作为version使用
    CdnDispatchTable photo_table = 2; // 作品CDN配置
    CdnDispatchTable headbg_table = 3; // 头像CDN
    CdnDispatchTable hot_photo_table = 4; // 热门作品CDN配置
}
```

然后通过 RPC 服务，将解析出来的数据，更新到调度表中。



main 程序来自于 `src/oc-lived.cpp`



main 程序来自于 `src/oc-server.cpp`

