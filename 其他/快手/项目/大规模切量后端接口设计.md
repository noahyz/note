---
title: 大规模切量后端接口设计
---

## 一、域名逃生以及回滚

### 1. 目前现状

已提供接口：

- 域名逃生切换： ` /api/v1/traffic/config/global_domain_replace`
- 回滚域名逃生切换： `/api/v1/traffic/config/global_domain_replace_revert`

 可以做到域名逃生以及回滚。但是目前只支持 kCDN 平台，KDD 平台不支持，需要补齐 KDD 平台域名逃生以及回滚的功能。

### 2. 解决方案

对于已有接口：

- 域名逃生切换： ` /api/v1/traffic/config/global_domain_replace` 
- 回滚域名逃生切换： `/api/v1/traffic/config/global_domain_replace_revert`

不改动请求参数类型、返回数据类型的情况下，完成支持 KDD 平台域名逃生以及回滚的功能。

## 二、故障切换以及回滚

### 1. 目前现状

已提供接口：

- 域名故障切换：` /api/v1/traffic/config/domain_replace`
- 回滚域名故障切换：` /api/v1/traffic/config/domain_replace_revert`

可以做到对故障域名进行切量。但是：

- 故障切换接口目前不支持 `isp=ALL` 和 `province=ALL` 类型参数，需要支持。
- 故障切换接口目前不支持 “占位符切换”，需要支持。

### 2. 解决方案

对于已有接口：

- 域名故障切换：` /api/v1/traffic/config/domain_replace`
- 回滚域名故障切换：` /api/v1/traffic/config/domain_replace_revert`

在不改动请求参数类型、返回数据类型的情况下，完成支持  `isp=ALL` 和 `province=ALL` 类型参数。

对于 “占位符切换” 不支持故障切换。内部会处理为 “域名逃生切换”。

// todo

## 三、查询调度配置

### 1. 目前现状

已提供接口：` /api/v1/traffic/config/list_by_domains` ，此接口目前有两个参数，分别为：

- domainName，类型为字符串数组，表示要查询的域名
- notUseEffective，类型为 bool，表示是否使用无效区间过滤

需要支持省份 provice 和运营商 isp 的参数过滤。

### 2. 解决方案

需求中因为要更改 ` /api/v1/traffic/config/list_by_domains` 的请求参数，直接更改此接口可能会造成之前调用此接口的服务出现问题，且直接修改已有接口的入参、出参，不符合规范。因此，我们新增一个接口。

#### a. 查询调度配置

接口：` /api/v1/traffic/config/get_traffic_config_by_domains` 

请求参数（JSON）：

| 参数            | 类型         | 是否必须 | 参数含义             | 备注                                     |
| --------------- | ------------ | -------- | -------------------- | ---------------------------------------- |
| domains         | string array | 是       | 需要查询的域名       | 不可为空                                 |
| notUseEffective | bool         | 否       | 是否使用无效区间过滤 | 默认为 false                             |
| province        | string       | 是       | 省份                 | 不可为空，如果查询所有省份，可以传 `all` |
| isp             | string       | 是       | 运营商               | 不可为空，如果查询所有 isp，可以传 `all` |

响应数据（JSON）：

| 参数                                   | 类型         | 参数含义           | 备注                                                       |
| -------------------------------------- | ------------ | ------------------ | ---------------------------------------------------------- |
| status                                 | int          | 状态码             | 成功返回 200                                               |
| message                                | string       | 返回状态说明       | 成功返回 `"success"`，失败返回原因                         |
| data                                   | array        | 返回数据           |                                                            |
| data.name                              | string       | 配置名             |                                                            |
| data.projectNameList                   | string array | 配置关联的项目名   |                                                            |
| data.configType                        | string       | 配置类型           | 包括："Manifest"、"KCdnCommon"<br />"Solar"、"Redirect" 等 |
| data.configAddress                     | string       | 配置地址           |                                                            |
| data.dimensions                        | string array | 支持的维度         |                                                            |
| data.availableDomains                  | object array | 可用的域名列表     |                                                            |
| data.availableDomains.domain           | string       | 可用的域名         |                                                            |
| data.availableDomains.freeTrafficTypes | string array | 支持的免流类型列表 |                                                            |
| data.availableDomains.resourceTypes    | string array | 资源类型列表       |                                                            |
| data.availableDomains.isps | string array | 支持的运营商列表 | |
| data.availableDomains.cdnProviders | string arryay | cdn厂商列表 | |
| data.availableDomains.protocols | 支持的协议列表 | |
| data.availableDomains.heats | string array | 冷热流列表 | |
| data.availableDomains.authTypes | string array | 防盗链加密类型列表 | |
| data.availableDomains.securedTypes | string array | URL加密类型列表 | |

## 四、逃生建议和切量建议

### 1. 目前现状

待新增

### 2. 解决方案

新增两个接口，分别用来给出对于故障域名的逃生建议措施、以及切量建议措施

#### a. 故障域名切量建议

接口：`/api/v1/traffic/config/get_domain_replace_proposal`

请求参数（JSON参数）：

| 参数     | 类型         | 是否必须 | 参数含义 | 备注                                     |
| -------- | ------------ | -------- | -------- | ---------------------------------------- |
| domains  | string array | 是       | 域名列表 | 不可为空                                 |
| province | string       | 是       | 省份     | 不可为空，如果查询所有省份，可以传 `all` |
| isp      | string       | 是       | 运营商   | 不可为空，如果查询所有 isp，可以传 `all` |

响应数据（JSON 格式）：

| 参数                                                   | 类型          | 参数含义           | 备注                               |
| ------------------------------------------------------ | ------------- | ------------------ | ---------------------------------- |
| status                                                 | int           | 状态码             | 成功返回 200                       |
| message                                                | string        | 返回状态说明       | 成功返回 `"success"`，失败返回原因 |
| data                                                   | object array  | 返回数据           |                                    |
| data[i].faultDomain                                    | string        | 故障域名           |                                    |
| data[i].configList                                     | object array  | 需要切换的配置列表 |                                    |
| data[i].configList[j].configName                       | string        | 配置名字           |                                    |
| data[i].configList[j].replaceDomainInfoList            | object string | 切换域名信息列表   |                                    |
| data[i].configList[j].replaceDomainInfoList[k].domain  | string        | 切换域名           |                                    |
| data[i].configList[j].replaceDomainInfoList[k].percent | float         | 流量分配比例       |                                    |

响应数据以 JSON 形式展示如下：

```json
{
  "status": 200,
  "message": "success",
  "data": [
    {
      "faultDomain": "a.com",
      "configList": [
        {
          "configName": "cdn.xxx.xxx",
          "replaceDomainInfoList": [
            {
              "domain": "b.com",
              "percent": 0.3
            },
            {
              "domain": "c.com",
              "percent": 0.4
            },
            {
              "domain": "d.com",
              "percent": 0.3
            }
          ],
          "backupDomainList": ["e.com", "f.com", "g.com"]
        },
        {
          "configName": "cdn.xxx1.xxx1",
          "replaceDomainInfoList": [
            {
              "domain": "h.com",
              "percent": 0.1
            },
            {
              "domain": "m.com",
              "percent": 0.9
            }
          ],
          "backupDomainList": ["u.com", "p.com", "q.com"]
        }
      ]
    }
  ]
}
```

#### b. 故障域名逃生建议

接口：` /api/v1/traffic/config/get_domain_escape_proposal`

请求参数（JSON参数）：

| 参数     | 类型         | 是否必须 | 参数含义 | 备注                                     |
| -------- | ------------ | -------- | -------- | ---------------------------------------- |
| domains  | string array | 是       | 域名列表 | 不可为空                                 |
| province | string       | 是       | 省份     | 不可为空，如果查询所有省份，可以传 `all` |
| isp      | string       | 是       | 运营商   | 不可为空，如果查询所有 isp，可以传 `all` |

响应数据（JSON 格式）：

| 参数                                    | 类型         | 参数含义           | 备注                               |
| --------------------------------------- | ------------ | ------------------ | ---------------------------------- |
| status                                  | int          | 状态码             | 成功返回 200                       |
| message                                 | string       | 返回状态说明       | 成功返回 `"success"`，失败返回原因 |
| data                                    | object array | 返回数据           |                                    |
| data[i].faultDomain                     | string       | 故障域名           |                                    |
| data[i].configList                      | object array | 需要切换的配置列表 |                                    |
| data[i].configList[j].configName        | string       | 配置名字           |                                    |
| data[i].configList[j].replaceDomainList | string array | 切换域名列表       |                                    |

响应数据以 JSON 形式展示如下：

```json
{
  "status": 200,
  "message": "success",
  "data": [
    {
      "faultDomain": "a.com",
      "configList": [
        {
          "configName": "cdn.xxx.xxx",
          "replaceDomainList": [ "b.com", "c.com", "d.com" ]
        },
        {
          "configName": "cdn.xxx1.xxx1",
          "replaceDomainInfoList": [ "u.com", "p.com", "q.com" ]
        }
      ]
    }
  ]
}
```

## 五、查询域名逃生操作记录、域名故障切换记录

### 1. 目前现状

待实现

### 2. 解决方案

新增两个接口分别用来 “查询域名逃生操作记录” 和 “查询域名故障切换记录”。

#### a. 查询域名逃生操作记录

接口：` /api/v1/traffic/config/get_global_domain_replace_record`

请求参数（JSON 格式）：

| 参数           | 类型   | 是否必须 | 参数含义               | 备注                                                         |
| -------------- | ------ | -------- | ---------------------- | ------------------------------------------------------------ |
| originalDomain | string | 是       | 被切换域名（故障域名） | 如果需要查询所有被切换域名，此字段请填写 `__ALL__`           |
| targetDomain   | string | 是       | 切换域名（替换域名）   | 如果需要查询所有切换域名，此字段请填写 `__ALL__`             |
| configName     | string | 是       | Kconf 配置名字         | 如果需要查询所有 Kconf 配置，此字段请填写 `__ALL__`          |
| isRevert       | string | 是       | 是否查询回滚操作记录   | 如果仅查询回滚操作记录，此字段请填写 `YES`<br />如果仅查询非回滚操作记录，此字段请填写 `NO`<br />如果查询所有操作记录，此字段请填写 `__ALL__` |
| operator       | string | 是       | 操作人                 | 如果需要查询所有操作人记录，此字段请填写 `__ALL__`           |
| revertOperator | string | 是       | 回滚操作人             | 如果需要查询所有回滚操作人记录，此字段请填写 `__ALL__`       |
| queryBeginTime | string | 是       | 查询开始时间           | 时间格式为 `YYYY-MM-DD hh:mm:ss`                             |
| queryEndTime   | string | 是       | 查询结束时间           | 时间格式为 `YYYY-MM-DD hh:mm:ss`                             |

响应数据（JSON 格式）：

| 参数                | 类型   | 参数含义 | 备注 |
| ------------------- | ------ | -------- | ---- |
| status          | int    | 状态码 | 成功返回 200 |
| message       | string | 返回状态说明 | 成功返回 `"success"`，失败返回原因 |
| data                | array  | 返回数据 |      |
| data.operationId    | string | 操作 id |      |
| data.originalDomain | string | 被切换域名 |      |
| data.targetDomain   | string | 切换域名 |      |
| data.configName     | string | Kconf 配置名字 |      |
| data.isRevert       | bool | 是否已经回滚 | true 表示未回滚<br />false 表示已回滚 |
| data.operator       | string | 操作人 |      |
| data.revertOperator | string | 回滚操作人 | |
| data.createTime    | string |此操作的创建时间| 时间格式为 `YYYY-MM-DD hh:mm:ss` |
| data.revertTime| string | 此操作的回滚时间 | 时间格式为 `YYYY-MM-DD hh:mm:ss`。如果未回滚，此字段为空字符串 |

#### b. 查询域名故障切换操作记录

接口：` /api/v1/traffic/config/get_domain_replace_record`

请求参数（JSON）：

| 参数                          | 类型                  | 是否必须 | 参数含义                 | 备注                                                         |
| ----------------------------- | --------------------- | -------- | ------------------------ | ------------------------------------------------------------ |
| originalDomain                | string                | 是       | 被切换域名（故障域名）   | 如果需要查询所有被切换域名，此字段请填写 `__ALL__`           |
| replaceDomainList             | array<br />字符串数组 | 是       | 切换域名列表（替换域名） | 如果需要查询所有切换域名，此字段请填写为空数组<br />注意：查询这些切换域名时，他们之间是 “或” 的关系 |
| configName                    | string                | 是       | Kconf 配置名字           | 如果需要查询所有 Kconf 配置，此字段请填写 `__ALL__`          |
| trafficFilter                 | json object           | 是       | 查询过滤条件             |                                                              |
| trafficFilter.asn             | string                | 是       | 自治系统标识             | 如果需要查询所有 asn，请填写 `__ALL__`                       |
| trafficFilter.isp             | string                | 是       | 运营商                   | 如果需要查询所有 isp，请填写 `__ALL__`                       |
| trafficFilter.countryOrRegion | string                | 是       | 国家或者地区             | 如果需要查询所有，请填写 `__ALL__`                           |
| trafficFilter.province        | string                | 是       | 省份                     | 如果需要查询所有，请填写 `__ALL__`                           |
| trafficFilter.freeTrafficType | string                | 是       | 免流类型                 | 如果需要查询所有，请填写 `__ALL__`<br />分为 "KCARD"、"BAIDU_CARD"、<br />"CM_RENWOKAN"、"CU_PACKAGE"、<br />"CUSTOM_FREE_TRAFFIC" |
| trafficFilter.resourceType    | string                | 是       | 资源类型                 | 如果需要查询所有，请填写 `__ALL__`<br />分为 "video"、"image"、"static"、"avatar" |
| trafficFilter.heat            | string                | 是       | 冷热流                   | 如果需要查询所有，请填写 `__ALL__`<br />"hot" 表示热数据<br />"cold" 表示冷数据 |
| trafficFilter.protocol        | string                | 是       | 协议                     | 如果需要查询所有，请填写 `__ALL__`<br />分为 "http" 和 "https" |
| isRevert                      | string                | 是       | 是否查询回滚操作记录     | 如果仅查询回滚操作记录，此字段请填写 `YES`<br />如果仅查询非回滚操作记录，此字段请填写 `NO`<br />如果查询所有操作记录，此字段请填写 `__ALL__` |
| operator                      | string                | 是       | 操作人                   | 如果需要查询所有操作人记录，此字段请填写 `__ALL__`           |
| revertOperator                | string                | 是       | 回滚操作人               | 如果需要查询所有回滚操作人记录，此字段请填写 `__ALL__`       |
| queryBeginTime                | string                | 是       | 查询开始时间             | 时间格式为 `YYYY-MM-DD hh:mm:ss`                             |
| queryEndTime                  | string                | 是       | 查询结束时间             | 时间格式为 `YYYY-MM-DD hh:mm:ss`                             |

响应数据（JSON）：

| 参数                | 类型   | 参数含义 | 备注 |
| ------------------- | ------ | -------- | ---- |
| status          | int    | 状态码 | 成功返回 200 |
| message       | string | 返回状态说明 | 成功返回 `"success"`，失败返回原因 |
| data                | array  | 返回数据 |      |
| data.operationId    | string | 操作 id |      |
| data.originalDomain | string | 被切换域名 |      |
| data.replaceDomainList | array<br />字符串数组 | 切换域名列表 |      |
| data.configName     | string | Kconf 配置名字 |      |
| data.isRevert       | bool | 是否已经回滚 | true 表示未回滚<br />false 表示已回滚 |
| data.operator       | string | 操作人 |      |
| data.revertOperator | string | 回滚操作人 | |
| data.trafficFilter           | json object           | 过滤条件   |              |
| data.trafficFilter.asn        | string                | 自治系统标识 |              |
| data.trafficFilter.isp        | string                | 运营商    |                    |
| data.trafficFilter.countryOrRegion | string                | 国家或者地区 |              |
| data.trafficFilter.province   | string                | 省份     |                      |
| data.trafficFilter.freeTrafficType | string                | 免流类型   |                  |
| data.trafficFilter.resourceType | string                | 资源类型   |                  |
| data.trafficFilter.heat       | string                | 冷热流    |                    |
| data.trafficFilter.protocol   | string                | 协议     |                      |
| data.createTime    | string |此操作的创建时间| 时间格式为 `YYYY-MM-DD hh:mm:ss` |
| data.revertTime| string | 此操作的回滚时间 | 时间格式为 `YYYY-MM-DD hh:mm:ss`。如果未回滚，此字段为空字符串 |

