---
title: redis中的发布订阅功能
---

本文基于 redis 源码 7.4.0 版本。

redis 中的发布订阅功能的实现在文件 `pubsub.c` 中。

### 一、概述

redis 客户端可以订阅任意数量的频道。当有新消息发送到频道时，这个消息就会被发送到订阅他的客户端。

还有一种功能是，可以订阅一个或多个符合给定模式的频道。每个模式以 `*` 作为匹配符，比如 `it*` 匹配所有以 `it` 开头的频道（`it.news、it_blog` 等）。

发布订阅的命令如下：

```
将消息发送到指定的频道
PUBLISH channel message

订阅给定的一个或多个频道的信息
SUBSCRIBE channel [channel ...]

退订给定的频道
UNSUBSCRIBE [channel [channel ...]]

订阅一个或多个符合给定模式的频道
PSUBSCRIBE pattern [pattern ...]

退订所有给定模式的频道
PUNSUBSCRIBE [pattern [pattern ...]]
```

### 二、实现

1. 发送消息给频道订阅者的场景

redis 服务端会维护一个 `serverPubSubChannels` 字典，来记录所有频道的订阅关系。

根据频道标识，我们即可以找到所有订阅这个频道的客户端。然后将消息发送给这些客户端。某个频道下有哪些客户端也是通过 双向链表 来保存的。

之前我们提到过，redis 中字典的实现是 哈希桶 方式，有着相同 key 的客户端会放在同一个 桶中，他们之间使用 链表进行连接。

2. 发送消息给模式订阅者的场景

redis 服务端会维护一个 `pubsub_patterns` 链表，记录了所有模式的订阅关系。

发送消息时，会遍历整个 pubsub_patterns 链表，查找那些与 channel 频道相匹配的模式，并将消息发送给订阅这些模式的客户端。

3. 客户端订阅频道的场景

客户端订阅频道的逻辑比较简单。将对应的客户端加入到 “保存频道订阅关系的字典” 的哈希桶中即可。

### 三、小结

redis 的这种发布订阅模式。

- 消息无法持久化，如果出现网络中断、redis 宕机等，消息就会被丢弃
- 发布/订阅模式可以发送消息，但无法记录历史消息



