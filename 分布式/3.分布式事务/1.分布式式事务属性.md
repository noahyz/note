---
title: 分布式式事务说明
---

一般认为事务必需遵从 ACID 特性。

- 原子性（`Atomicity`）：一个事务所包含的所有操作，要么全部完成，要么全部不完成，不会在中间某个环节结束。即使事务在执行过程中发生错误，也会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样，即事务中的操作不可分隔。
- 一致性（`Consistency`）：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。事务必需保证数据库可以从一个一致的状态转移到另一个一致的状态。这种一致性要求不仅指常见的数据库完整性约束（例如主键、外键、触发器等约束），还需要由用户来保证。比如：A像B转100块，A是工商，B是招商，分属两个数据库，用户需要保证两个数据库中A+B=100，两个数据库的数据需要是一致的。
- 隔离性（`Isolation`）：数据库允许多个并发事务同时对其数据进行读写和修改，隔离性可以防止在多个事务并发执行时，由于交叉执行而导致数据出现异常的情况。不同的隔离级别有着不同的保证。
- 持久性（`Durability`）：事务结束后，对数据的修改就是永久的，即便系统出现故障也不会丢失数据。即会将数据写入非易失性存储设备。

分布式事务可以理解为单机事务的两种变体。

- 第一种变体是：同一份数据需要在多个副本上更新，即一个分布式事务需要更新所有的副本。一般可以通过单主复制来解决。
- 第二种变体是：数据进行了分区，比如A向B转账，A和B的账户分属不同的银行。这样的事务跨越多个节点，还要同时保证整体数据一致性和事务的ACID属性。是分布式事务的需要重点解决的问题。

重点讨论第二种变体，分别从 ACID 四大特性进行切入。

### 一、持久性

只需要在客户端返回响应之前，确保将数据存储在非易失性存储设备中即可。通常还会包含一些 WAL(`Write-ahead Logging`，预写日志)或者其他日志文件。

虽然非易失性存储设备可能会损坏，但不考虑极端的情况（数据和备份全部损坏），通过备份就可以解决此问题。分布式事务的持久性的解决思路和单机事务没有太大差别。

### 二、一致性

事务的一致性不仅取决于数据库，还取决于用户(应用程序)的业务逻辑。一致性是一个需要应用程序和数据库一起控制的属性。因此通常不讨论分布式事务的一致性。

### 三、原子性

为了实现原子性，分布式事务提出了“原子提交”(`Atomic Commit`)。

如果出现分布式系统部分失效，事务需要具备回滚的能力。比如：A向B转账，A扣除了钱之后，B故障，此时需要回滚事务，将A的钱退回去。

### 四、隔离性

为了实现隔离性，分布式事务提出了“并发控制”（`Concurrency Control`）。

主要通过隔离其他尝试使用相同数据的并发事务以实现隔离性，并发控制通常设计锁和多版本并发控制。

