---
title: 2.数据的分布式
---

存储数据的数据库也需要分布式，从而增加数据库的可用性、可扩展性、高性能等。

数据的分布式最常见的两种技术，就是数据分区和数据复制

## 一、数据分区

分区是指将一个数据集拆分为多个较小的数据集，同时将存储和处理这些较小数据集的责任分配给分布式系统中的不同节点。这样，我们可以通过向系统中增加更多节点来增加系统可以存储和处理的数据规模。分区增加了数据的可管理性、可用性和可扩展性。

分区分为**垂直分区**、**水平分区**。这两种分区方式也是来源于关系型数据库。

- 垂直分区：对表的列进行拆分，将某些列的整列数据拆分到特定的分区，并放入不同的表中。垂直分区减小了表的宽度。例如：可以将不经常使用的列或者包含了大 text 类型或大 blob 类型的列垂直分区，确保数据完整性的同时提高访问性能。比如列式数据库就可以看作是垂直分区的数据库。
- 水平分区：对表的行进行拆分，将不同的行放入不同的表中。

因为一个表的列是有限的，这就导致了垂直分区不能超过一定的限度。而水平分区可以无限拆分，因此水平分区更加常见。

在分布式系统领域，水平分区常称为分片。在不同系统中分片也有不同的称呼，MongoDB 和 Elasticsearch 中称为 shard，HBase 中称为 region，Bigtable 中称为 tablet，Cassndra 和 Riak 中称为 vnode。

### 1. 水平分区的算法

#### (1). 范围分区

根据指定的关键字将数据集拆分为若干连续的范围，每个范围存储到一个单独的节点上。用于分区的关键字也叫分区键。

比如按年来拆分数据就是一个范围分区的例子。通常会选择额外的负载均衡节点或者系统中一个节点来接收客户端请求，然后根据范围分区算法，确定请求应该重定向到那个节点或那几个节点。

范围分区的优点如下：

- 实现起来相对简单
- 能够对用来进行范围分区的关键字执行范围查询
- 当使用分区键进行范围查询时，如果范围较小并且位于同一个节点，此时性能很好
- 很容易通过修改范围边界增加或减少范围数据，能够简单有效的调整范围，重新分区，以平衡负载。

范围分区的缺点如下：

- 无法使用分区键之外的其他关键字进行范围查询
- 当查询的范围较大且位于多个节点时，性能较差
- 可能会产生数据分区不均、请求流量不均的问题，导致某些数据的热点现象，从而某些节点的负载很高。

使用范围分区的分布式存储系统有：Google Bigtable、Apache HBase、PingCAP TiKV 等。

#### (2). 哈希分区

将指定的关键字经过哈希函数的计算，得到的结果来决定该数据集的分区。

优点：数据分布几乎随机，所以分区相对均匀，能在一定程度上避免热点问题

缺点：

- 在不额外存储数据的情况下，无法执行范围查询
- 如果要增加或删除数据节点，可能需要修改哈希函数，导致许多现有的数据需要重新映射，引起数据大规模迁移。并且在此期间，系统可能无法继续工作。

#### (3). 一致性哈希

用来缓解哈希分区增加或删除节点时，引起的大规模数据移动问题。

一致性哈希将整个哈希值组织成一个哈希环，分布式节点映射到圆环上，数据存储在按照顺时针方向遇到的第一个节点上。这样，节点的增减只需要重新分配哈希环上的一部分数据，改善了哈希分区大规模迁移的缺点。

- 当系统节点太少时，还是容易产生数据分布不均的问题
- 当一个节点发生异常需要下线时，改节点的数据全部转移到顺时针方向的节点上，从而导致此节点存储大量数据，大量负载会倾斜到该节点

于是引入虚拟节点，让数据分布更加均匀。并且，如果系统中有不同配置、不同性能的机器，则可以改变不同机器对应虚拟节点的数量，从而让他们承担不同的负载。

- 在不额外存储数据的情况下，一致性哈希依然无法高效的进行范围查询。任何范围查询都会发送到多个节点上

## 二、数据复制

数据复制指将同一份数据冗余存储在多个节点上，节点间通过网络来同步数据，使之保持一致。复制可以和分区一起使用。

复制的好处有：

- 增强数据的可用性和安全性。通过复制技术将数据冗余存储，及时系统部分节点发生故障，系统整体也能继续工作。
- 减少数据的响应时间。通过复制技术将数据存储到各地的数据中心，这样可以就近访问。
- 增加吞吐量。一台机器能够处理的请求数存在物理上限。复制出来的多台服务器，可以使系统整体的处理性能成倍增长。

但复制带来的最主要的问题是：一致性问题。

### 1. 单主复制

也称为主从复制或主从同步，主节点收到写请求时，除了将数据写入本地存储，还要负责将这次数据变更同步给所有从节点，以确保所有的副本保持数据一致。

同步数据的方式一般分为三类：同步复制、异步复制、半同步复制。

#### (1). 同步复制

主节点执行完一个写请求（或一个事务）后，必须等待所有的从节点都执行完毕，并收到确认信息后，才可以回复客户端写入成功。

优点：提升了数据的可用性，即使主节点在写入完成后立即宕机，数据也不会丢失。并且数据保证了一致性。

缺点：写请求的性能会受到影响，如果某个从节点的 IO负载过高导致处理请求慢，会严重影响整个写请求。

#### (2). 异步复制

主节点执行完写请求后，会立即将结果返回给客户端，无需等待其他副本是否写入完成。

优点：不会影响写请求的性能

缺点：数据的一致性和持久性无法保证

#### (3). 半同步复制

主节点只需要等待至少一个从节点同步写操作并返回完成信息即可，无需等待所有节点都完成。相当于有一个从节点是同步复制，其余从节点则是异步复制。这样，保证至少有两个节点拥有最新的数据副本，该从节点可以随时接替从节点的工作。

#### (4). 小总结

单主复制的优点：

- 仅在主节点执行并发写操作，能够保证操作的顺序，不用考虑如何处理各个节点的数据冲突问题。因此更容易支持事务类操作，分布式事务是非常消耗性能的。
- 对于读请求较多的系统，单主复制是可扩展的，增加从节点即可提升读性能。

单主复制的缺点：

- 对于写请求比较多的系统，很难扩展，主节点很容易成为性能瓶颈。

- 当主节点宕机时，从节点提升为主节点不是即时的，可能会造成一些停机时间，甚至产生错误。

  比如我们通过心跳超时检测主节点是否宕机，但由于网络分区、网络延迟等问题，可能会导致集群出现两个主节点，产生“脑裂”问题。此时如果两个主节点都在处理写请求，可能会造成数据损坏之类的灾难性后果。

### 2. 多主复制

多主复制会导致多个节点上的数据不一致，带来数据冲突问题。一般的冲突解决方法有：

- 由客户端解决冲突：将冲突的数据全部返回给客户端，由客户端最终处理冲突数据。比如购物车应用，解决冲突的逻辑是保留购物车中所有冲突的商品，并全部返回给用户，由用户去重新选择购物车里的商品，最终将数据写入，解决冲突。
- 最后写入胜利（`LWW, Last Write Wins`）：让系统中的每个节点为每个写入请求标记上唯一时间戳或唯一自增ID。当冲突发生时，系统选择具有最新时间戳或最新ID版本的数据。但注意：分布式系统很难有一个统一的全局时间概念。
- 因果关系跟踪：系统使用一种算法来跟踪不同请求之间的因果关系，并以此判断请求的先后顺序。比如：写请求A是发帖操作，写请求B是回贴操作，由于先有发帖操作才会有回贴操作，所以写请求B必然是在写请求A之后发生的。但注意：因果关系跟踪存在局限性，有些请求不存在因果关系。

多主复制的优点：

- 增加主节点的容错性。一个主节点故障时，另一个主节点仍能工作
- 多个主节点执行写请求，可以分担负载的压力
- 应用程序可以将写请求路由到不同的主节点，比如就近位置，可以减小往返时间，提升写请求的响应速度

多主复制的缺点：

- 比较复杂，数据冲突问题无法很好解决，极端情况下可能会造成数据损坏

多主复制一般用于多个地域建立多个数据中心的存储系统，避免写请求跨越数据中心。例如全球各地有多个数据中心，可以就近访问。

### 3. 无主复制

基本思想：客户端将请求发送到多个节点，在某些情况下甚至会发送给所有节点。一旦得到其中一些节点的确认响应，就认为这次写成功了。同样的，客户端也会同时请求多个节点来获取数据和版本号，然后根据版本号决定使用那个值。

>一般无主复制有着不同的协调请求方式，一种是客户端直接将写操作发送给多个节点。而另一种是在节点中选出一个协调节点，客户端将请求发送到协调节点，再由协调节点代表客户端转发到多个节点，经过多个节点确认后再由协调节点响应客户端。注意：无主复制不强制写操作的顺序。

如果客户端识别到了旧数据，如何修复呢？

- 读修复：让客户端负责更新数据。客户端从多个节点读取到数据，检测到旧数据后，客户端可以发送一个带有最新值的写请求到旧数据所在的节点，以此更新节点的数据。

- 反熵过程：新建一个后台进程来修复数据，该进程找出错误的数据，并从存储最新的数据的节点中将数据复制到错误的节点。注意：反熵过程不保证写操作的顺序，只保证最后结果一致。

  >使用 Merkle 树将数据按关键字分为几个范围，每个范围计算出一个哈希值并作为树的叶子节点，然后自底向上一层层合并到根节点。这样，树的每个分支都可以独立进行对比，不要求完全传输整棵树；同时，如果两棵树的根节点相同，那么叶子节点的值也会相同；如果根节点不同，则说明某些副本的数据不同，此时继续往子节点中查找（只需要传输这部分子节点的数据），直到叶子节点找到不同的关键字所在的范围。
  >
  >通过 Merkle 树可以快速找到哪些范围的哈希值发生了变化，快速定位不一致的数据，并且只传输较少的数据进行比较。

无主复制的优势是：可以容忍节点故障。

#### (1). 基于 Quorum 的数据冗余机制

Quorum（法定人数）机制是分布式系统中用来保证数据冗余和最终一致性的一种算法。

基于 Quorum 的数据冗余机制保证了在一个由 N 个节点组成的系统中，要求至少 W 个节点写入成功，并且需要同时从 R 个节点中读取数据，只要 `W+R>N` 且 `W>N/2`，则读取的 R 个返回值中至少包含一个最新的值。

其中 `W>N/2` 这条规则主要用于保证数据的串行化修改，两个不同的写请求不能同时成功修改一份数据。

极端情况下，在 N 个节点组成的系统中，同时写入和读取的最大节点数均为 N，所以最多可以设定 W=N 且 R=N，即 `W+R=2N`。这种情况下，要等待所有的节点都写入成功，并且从所有节点读取。此时不会产生任何混乱的数据。但这种情况下，一次写请求或读请求的延迟由 W 或 R 个节点中最慢的一个决定，读写请求可能会等待相当长的时间。因为，为了降低延迟，W 和 R 的值通常设置得比 N 小。

因此，最小读写节点数可以作为系统在读写性能方面的可调节参数。