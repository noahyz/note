---
title: 2.原子性保证-原子提交
---

原子性：所有的操作要么都执行，要么都不执行。程序员可以安全的将一系列相关的、不可分隔的操作组合成一个整体，实现许多业务需求。

“原子提交” 是为了保证分布式事务的原子性的。

### 一、难点

原子性涉及了硬件和软件，两者都可能出现意外故障。

常见的机械磁盘一般可以保证 512 字节的原子写，也就是说，即使遭遇突然断电等意外情况，一般的机械磁盘也可以保证当前 512 字节的成功写入。如果写入的数据大于 512 字节，则原子写得不到保障。

### 二、方法

常见的方法是使用 日志 或 WAL 这类技术。即先将操作的元数据写入一个单独的日志文件，同时还有表示操作是否完成的标记。如果系统在写入过程中发生故障，那么基于这些数据，系统恢复后依然能够识别出哪些操作在故障发生前已完成，然后通过撤销所有的操作来回滚事务；或者通过完成剩余未执行的操作来继续提交事务。

但是在分布式系统中，原子性问题更加复杂，因为节点分布在不可靠的网络中。我们需要确保一个操作在多个节点上的原子性，也就是说，操作要么在所有节点上都生效，要么不在任何一个节点上生效，每个节点提交或中止事务的操作需要保持一致。

### 三、原子提交协议

分布式事务的原子性通过原子提交协议（`Atomic Commit Protocol`，ACP）来实现。原子提交协议必须满足三个特性：

- 协定性（`Agreement`）：所有进程都决议出同一个值，相当于所有进程要么一起提交事务，要么一起终止事务，不存在两个进程一个提交事务，一个终止事务的情况
- 有效性（`Validity`）：如果所有进程都决定提交事务并且没有任何故障发生，那么最终整个系统将提交事务。只要有一个进程决定中止事务，系统最终将中止事务。
- 终止性（`Termination`）：又分为弱终止条件和强终止条件。
  - 弱终止条件（`Weak Termination Condition`）：如果没有任何故障发生，那么所有进程最终都会做出决议（提交或终止事务）
  - 强终止条件（`Strong Termination Condition`）：也称为非阻塞条件（`Non-Blocking Condition`），是指没有发生故障的进程最终会做出决议

