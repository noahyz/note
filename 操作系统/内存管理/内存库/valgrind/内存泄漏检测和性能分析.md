---
title: linux下使用 valgrind 工具进行内存泄漏检测和性能分析
---

valgrind 工具集包括如下工具

```
1、memcheck：检查程序中的内存问题，如泄漏、越界、非法指针等。
2、callgrind：检测程序代码的运行时间和调用过程，以及分析程序性能。
3、cachegrind：分析CPU的cache命中率、丢失率，用于进行代码优化。
4、helgrind：用于检查多线程程序的竞态条件。
5、massif：堆栈分析器，指示程序中使用了多少堆内存等信息。
```

这几个工具的使用是通过命令：`valgrand –tool=name` 程序名来分别调用的，当不指定 tool 参数时默认是 `–tool=memcheck`

### 一、memcheck

```
最常用的工具，用来检测程序中出现的内存问题，所有对内存的读写都会被检测到，一切对malloc、free、new、delete的调用都会被捕获。所以，它能检测以下问题：
   1、对未初始化内存的使用；
   2、读/写释放后的内存块；
   3、读/写超出malloc分配的内存块；
   4、读/写不适当的栈中内存块；
   5、内存泄漏，指向一块内存的指针永远丢失；
   6、不正确的malloc/free或new/delete匹配；
   7、memcpy()相关函数中的dst和src指针重叠。
```

使用方法：`valgrind –leak-check=full ./ 程序名`

### 二、callgrind

Callgrind 收集程序运行时的一些数据，建立函数调用关系图，还可以有选择地进行 cache 模拟。在运行结束时，它会把分析数据写入一个文件。

使用 `valgrind -tool=callgrind 程序`。执行完可以生成一个文件，可以通过 KCachegrind 工具来分析

### 三、cachegrind

Cache分析器，它模拟CPU中的一级缓存I1，Dl和二级缓存，能够精确地指出程序中cache的丢失和命中。如果需要，它还能够为我们提供cache丢失次数，内存引用次数，以及每行代码，每个函数，每个模块，整个程序产生的指令数。这对优化程序有很大的帮助。

使用方法：`valgrind –tool=cachegrind 程序名`

### 四、helgrind

它主要用来检查多线程程序中出现的竞争问题。Helgrind寻找内存中被多个线程访问，而又没有一贯加锁的区域，这些区域往往是线程之间失去同步的地方，而且会导致难以发掘的错误。Helgrind实现了名为“Eraser”的竞争检测算法，并做了进一步改进，减少了报告错误的次数。不过，Helgrind仍然处于实验阶段。

使用 `valgrind -tool=helgrind 程序名` 即可检测

### 五、massif

堆栈分析器，它能测量程序在堆栈中使用了多少内存，告诉我们堆块，堆管理块和栈的大小。Massif能帮助我们减少内存的使用，在带有虚拟内存的现代系统中，它还能够加速我们程序的运行，减少程序停留在交换区中的几率。

   Massif对内存的分配和释放做profile。程序开发者通过它可以深入了解程序的内存使用行为，从而对内存使用进行优化。这个功能对C++尤其有用，因为C++有很多隐藏的内存分配和释放。

